#!/usr/bin/env bash
#######################################################################
#                            BEGIN CONFIG                             #
#######################################################################

# Colors: FG (foreground), BG (background), HL (highlighted)
FG_COLOR="#bbbbbb"
BG_COLOR="#111111"
HLFG_COLOR="#111111"
HLBG_COLOR="#bbbbbb"
BORDER_COLOR="#222222"

# Options not related to colors
ROFI_OPTIONS=(-theme ~/.config/rofi/profil.rasi)
# Zenity options
ZENITY_TITLE="Power Profiles"
ZENITY_TEXT="Set Profiles:"
ZENITY_OPTIONS=(--column= --hide-header)

#######################################################################
#                             END CONFIG                              #
#######################################################################

# Whether to ask for user's confirmation
enable_confirmation=false

# Preferred launcher if both are available
preferred_launcher="rofi"

usage="$(basename "$0") [-h] [-c] [-p name] -- display a menu for power profiles.

where:
    -h  show this help text
    -c  ask for user confirmation
    -p  preferred launcher (rofi or zenity)

This script depends on:
  - cpupower or tlp (for power management)
  - rofi or zenity."

# Check whether the user-defined launcher is valid
launcher_list=(rofi zenity)
function check_launcher() {
  if [[ ! "${launcher_list[@]}" =~ (^|[[:space:]])"$1"($|[[:space:]]) ]]; then
    echo "Supported launchers: ${launcher_list[*]}"
    exit 1
  else
    # Get array with unique elements and preferred launcher first
    # Note: uniq expects a sorted list, so we cannot use it
    i=1
    launcher_list=($(for l in "$1" "${launcher_list[@]}"; do printf "%i %s\n" "$i" "$l"; let i+=1; done \
      | sort -uk2 | sort -nk1 | cut -d' ' -f2- | tr '\n' ' '))
  fi
}

# Parse CLI arguments
while getopts "hcp:" option; do
  case "${option}" in
    h) echo "${usage}"
       exit 0
       ;;
    c) enable_confirmation=true
       ;;
    p) preferred_launcher="${OPTARG}"
       check_launcher "${preferred_launcher}"
       ;;
    *) exit 1
       ;;
  esac
done

# Check whether a command exists
function command_exists() {
  command -v "$1" &> /dev/null 2>&1
}

# VOID LINUX: Remove systemctl requirement
# if ! command_exists systemctl ; then
#   exit 1
# fi

# default_menu_options defined as an associative array
typeset -A default_menu_options

# Check available power management tools
POWER_TOOL=""
if command_exists powerprofilesctl; then
    # If powerprofilesctl is installed (from gnome-power-manager)
    POWER_TOOL="powerprofilesctl"
    default_menu_options=(
      [  Performance]="powerprofilesctl set performance"
      [   Balanced]="powerprofilesctl set balanced"
      [  Power Saver]="powerprofilesctl set power-saver"
      [  Cancel]=""
    )
elif command_exists cpupower; then
    # Use cpupower for CPU frequency scaling
    POWER_TOOL="cpupower"
    default_menu_options=(
      [  Performance]="sudo cpupower frequency-set -g performance"
      [   Balanced]="sudo cpupower frequency-set -g ondemand"
      [  Power Saver]="sudo cpupower frequency-set -g powersave"
      [  Cancel]=""
    )
elif command_exists tlp; then
    # Use tlp for power management
    POWER_TOOL="tlp"
    default_menu_options=(
      [  Performance]="sudo tlp ac"
      [   Balanced]="sudo tlp auto"
      [  Power Saver]="sudo tlp bat"
      [  Cancel]=""
    )
else
    echo "No power management tool found!"
    echo "Install one of:"
    echo "  - cpupower: sudo xbps-install -S cpupower"
    echo "  - tlp: sudo xbps-install -S tlp"
    echo "  - power-profiles-daemon: sudo xbps-install -S power-profiles-daemon"
    exit 1
fi

# The menu that will be displayed
typeset -A menu
menu=()

# Check which profiles are available and add to menu
if [[ "$POWER_TOOL" == "powerprofilesctl" ]]; then
    # Check available profiles for powerprofilesctl
    for key in "${!default_menu_options[@]}"; do
        if [[ "$key" == *"Cancel"* ]]; then
            menu[${key}]=${default_menu_options[${key}]}
        else
            grep_arg=${default_menu_options[${key}]##* }
            if powerprofilesctl list 2>/dev/null | grep -q "$grep_arg"; then
                menu[${key}]=${default_menu_options[${key}]}
            fi
        fi
    done
else
    # For cpupower and tlp, add all options
    for key in "${!default_menu_options[@]}"; do
        menu[${key}]=${default_menu_options[${key}]}
    done
fi

unset default_menu_options

menu_nrows=${#menu[@]}

# Menu entries that may trigger a confirmation message
menu_confirm="Performance Balanced Power-Saver"

launcher_exe=""
launcher_options=""
rofi_colors=""

function prepare_launcher() {
  if [[ "$1" == "rofi" ]]; then
    rofi_colors=(-bc "${BORDER_COLOR}" -bg "${BG_COLOR}" -fg "${FG_COLOR}" \
        -hlfg "${HLFG_COLOR}" -hlbg "${HLBG_COLOR}")
    launcher_exe="rofi"
    launcher_options=(-dmenu -i -lines "${menu_nrows}" -p "Power Profile" \
        "${rofi_colors}" "${ROFI_OPTIONS[@]}")
  elif [[ "$1" == "zenity" ]]; then
    launcher_exe="zenity"
    launcher_options=(--list --title="${ZENITY_TITLE}" --text="${ZENITY_TEXT}" \
        "${ZENITY_OPTIONS[@]}")
  fi
}

for l in "${launcher_list[@]}"; do
  if command_exists "${l}" ; then
    prepare_launcher "${l}"
    break
  fi
done

# No launcher available
if [[ -z "${launcher_exe}" ]]; then
  echo "Error: No launcher (rofi/zenity) found!"
  exit 1
fi

launcher=(${launcher_exe} "${launcher_options[@]}")
selection="$(printf '%s\n' "${!menu[@]}" | sort | "${launcher[@]}")"

function ask_confirmation() {
  if [ "${launcher_exe}" == "rofi" ]; then
    confirmed=$(echo -e "Yes\nNo" | rofi -dmenu -i -lines 2 -p "${selection}?" \
      "${rofi_colors}" "${ROFI_OPTIONS[@]}")
    [ "${confirmed}" == "Yes" ] && confirmed=0
  elif [ "${launcher_exe}" == "zenity" ]; then
    zenity --question --text "Are you sure you want to switch to ${selection}?"
    confirmed=$?
  fi

  if [ "${confirmed}" == 0 ]; then
    eval "${menu[${selection}]}"
  fi
}

if [[ $? -eq 0 && ! -z ${selection} ]]; then
  if [[ "${enable_confirmation}" = true && \
        ${menu_confirm} =~ (^|[[:space:]])"${selection}"($|[[:space:]]) ]]; then
    ask_confirmation
  else
    # Execute the command
    if [[ "${selection}" != *"Cancel"* ]]; then
        eval "${menu[${selection}]}"
        # Show notification if available
        if command_exists notify-send; then
            notify-send "Power Profile" "Switched to ${selection}"
        fi
    fi
  fi
fi
